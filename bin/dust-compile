/* vim: set filetype=javascript: */
/*jslint node: true */

var dust = require('dust'),
    fs = require('fs'),
    path = require('path'),
    exec = require('child_process').exec,
    argv = process.argv;

var src_dir = argv[2], 
    dust_file = (function () {
        var mod = require.paths
                         .filter(function (p) {
                            return path.basename(p) === 'dust';
                         })[0];
        if (!mod) throw { message: 'Could not find dust module' };

        return path.join(mod, 'lib/dust.js');
    })(),
    dust_lib = fs.readFileSync(dust_file, 'utf-8');
    config = (function () {
        var config_path = path.join(src_dir, 'config.js');
        var settings = fs.readFileSync(config_path, 'utf-8');
        return JSON.parse(settings);
    })(),
    root = config.root || '';

for(var target in config.targets) { 

    var options = config.targets[target],
        target_path = path.join(src_dir, root, target),
        output = fs.createWriteStream(target_path),
        includes = options.templates;

    if (options.bundle) {
        output.write(dust_lib);
    }

    includes.forEach(function (template) {
        var extname = path.extname(template),
            filepath = path.join(src_dir, template);

        console.log("Compiling '" + filepath + "' to '" + target_path + "'");
            
        var contents = fs.readFileSync(filepath, 'utf-8'),
            filename = path.basename(template, '.dust'),
            compiled = dust.compile(contents, filename);

        output.write(compiled);
    });

    output.destroySoon();
}

exec('growlnotify -m "Templates Compiled" Dust',
     function (err, stdout, stderr) {
        if (err) {
            throw err;
        }
     });

console.log("Templates Compiled");
